--*************************************************************************************************
--** Script Name   : RL_3X_FIN_STG_ORD_EXTRC_DTL_ETL
--** DIAL Master ID: 12381.TB.999.1
--** Description   : Outbound extract of L2 SO DTL
--** Dependency    : after L2 ORDERS is complete
--** Change History:
--** By             Date       Change
--** -----------    ---------- -------------------------------------------------------------------
--** A Puente       10/Apr/08  Created
--** A Puente	    18/May/09  Use table STG_FIN_SO_DTL_ADJ_F_ETL as source instead of SO_DTL_RPT_F
--** A Puente	    10/Aug/09  Added INSERT WITH NO ROLLBACK INTO from STG_FIN_RZ_SO_DOR_MDL_UNITS_PER_SKU_QT_ETL fo HPS records
--** A Puente	    16/Oct/09  Changed Source table back to SO_DTL_RPT_F
--** E Tilley	    29/Mar/10  Add FIN_RPTBL_FG to ID Dor records downstream
--** A Puente	    10/Jun/10  Added field NET_DEALER_PRC_USD_AM
--** A Puente	    10/Jun/10  Added field PIPELN_CD
--** A Puente	    10/Jun/10  Added field STD_CST_EXT_SO_USD_AM
--** A Puente	    10/Jun/10  Added field PRIM_AGNT_ID
--** A Puente	    10/Jun/10  Added field DLVR_MTHD_CD
--** A Puente	    10/Jun/10  Added field MKT_OFR_CD
--** A Puente	    10/Jun/10  Added field SRVC_GDS_PROD_ID
--** A Puente	    10/Jun/10  Added field DRVD_END_CUST_ID
--** A Puente	    06/Sep/10  Added field PKG_PROD_ID
--** A Puente	    06/Oct/10  Split single insert statement into two separate statements based on FIN_CLOSE_DT to speed-up performance
--** A Puente	    04/Nov/10  Added filter to remove IPG dummy rebates
--** A Puente	    08/Dec/10  Added field SUPLYG_DIV_SUB_ENT_CD,
--** A Puente	    11/Jan/11  Added field UNRSTD_BUS_AREA_CD
--** A Puente	    03/Mar/11  removed hardcoded value to field SRVC_GDS_PROD_ID to fix bug 13098
--** A Puente	    27/Apr/11  Excluding Cross Boarder O, X and Z records
--** I Lee          29/Apr/11  Added RSTD_CUST_UPD_IND, RSTD_CUST_UPD_GMT_TS Per IVC Cust ID restatement project
--** I Lee          29/Apr/11  Updated WHERE condition to include CUST ID Restated records
--** A Puente	    27/Apr/11  Excluding Cross Border Y records if updated by Customer Restatement Process
--** David Rodriguez	22/Aug/11	Added REC_EXPLN_PRCS_CD,DRVD_END_CUST_PATH_CD for MBP5
-- 2012-05-16   Gonzalez, Karina  Commented out the Timestamps in the Where clause and added a new Join to STG_ORD_EXTRC_DRV_ETL table to fix DQ Issue: 9803
-- zhu, xiu-juan   29/Aug/13   Add RTE_CD, MKT_SEG_CD and MKT_OFR_CD and pull value for them. Add left join WBS_D
-- Zhu, Xiu-Juan   5/Sep/13    Change left join to inner join for WBS_D
-- 2013-12-16 	Dolphin Lei(qiang.lei@hp.com)  Sales Comps:Add new columns CNTRCT_STRT_DT, CNTRCT_END_DT, SO_PREPAYM_TYPE_CD, TOT_NET_EXT_SO_AM and TOT_NET_EXT_SO_USD_A
-- 2014-05-28   Joe He(zong-hai.he@hp.com)  	Project EG Instrumentation: Added 1 columns PRIM_SO_ADJ_CD
-- 2016-02-27   Bao,yan(yan.bao@hpe.com)    for solving EGI EMEA Order Issue, comment out line316-319 and line 591 to 594.
-- 2016-10-21   qian-ke.meng@hpe.com	For EDW Seattle: Add SSK for Seattle change in line 584 and 589
-- 2016-12-20   qian-ke.meng@hpe.com	For EDW Seattle: Add SSK for Seattle change in line 309 and 314
--------------------------------------------------------------------------------------------------------------------------------------

SET SCHEMA %(ETL_SCHEMA)s;
--SET SCHEMA FIN_SBX;


PURGEDATA STG_ORD_EXTRC_DTL_ETL;

INSERT WITH NO ROLLBACK INTO STG_ORD_EXTRC_DTL_ETL(
    SPRN_CO_ID,
    SLS_OFF_CD,
    CUST_CNTRCT_ID,
    DSTRB_CHNL_CD,
    SLS_FRC_CD,
    QTA_PROD_LN_ID,
    --SO_TYPE_CLS_NM,
    NET_EXT_SO_LC_AM,
    SO_DTL_QT,
    SO_DTL_EXT_QT,
    GRS_EXT_SO_LC_AM,
    --FDW_WORLD_CTRY_CD,
    NET_EXT_SO_USD_AM,
    GRS_EXT_SO_USD_AM,
    ORD_RSN_CD,
    CUST_PO_ID,
    BUS_TYPE_CD,
    --SO_ADJ_QT,
    PROMO_CD,
    CUST_REQD_DLVR_DT,
    SHPT_ISO_CTRY_CD,
    LOAD_JOB_NR,
    UPD_GMT_TS,
    LEG_SO_ID,
    LEG_SO_LN_ITM_ID,
    INVN_CLS_CD,
    --REV_FG,
    --SO_ADJ_USD_AM,
    --SO_ADJ_LC_AM,
    SLS_REP_CD,
    CUST_APP_CD,
    SLS_ORG_CD,
    --GL_GRP_ACCT_ID,
    BIG_DEAL_ID,
    SO_MTHD_CD,
    --LEG_STATSTCL_BILL_CD,
    CMRCL_CD,
    REC_EXPLN_CD,
    LC_CD,
    LC_EXCH_RT,
    --FDW_PROD_HIER_LVL_02_CD,
    PRFT_CTR_CD,
    --FUNC_AREA_CD,
    SO_ID,
    SRC_SYS_KY,
    ORD_CRT_DT,
    SO_LN_ITM_ID,
    EFF_FRM_GMT_TS,
    CONTRA_FG,
    BUS_AREA_CD,
    PROD_ID,
    SLDT_CUST_ID,
    SHPT_CUST_ID,
    BILT_CUST_ID,
    END_CUST_ID,
    CROSS_BORD_FG,
    SO_TYPE_CD,
    OM_SRC_SYS_KY,
    SLS_CHNL_CD,
    FIN_CLOSE_DT,
    SO_DTL_STAT_CD,
    SRC_PROD_LN_ID,
    DOC_CRNCY_CD,
    LEGL_CO_CD,
    --SO_ADJ_CD,
    --EXTRC_EFF_TS,
    EFF_TO_GMT_TS,
    DRVD_END_CUST_ID,
    --QTA_CR_FG,
    --HP_QTA_CNTB_FG,
    --MKT_CHNL_CD,
    CBN_ID,
    --SLDT_CUST_ID_VAL_STAT_CD,
    --SHPT_CUST_ID_VAL_STAT_CD,
    --BILT_CUST_ID_VAL_STAT_CD,
    --END_CUST_ID_VAL_STAT_CD	,
    --LEG_ORD_TYPE_CD,
    --PROD_OPT_CD,
    --SPLIT_WORLD_CTRY_CD,
    --VALU_VOL_NM,
    GRS_EXT_SO_AM,
    NET_EXT_SO_AM,
    ORIG_PROD_ID,
    --SO_ADJ_AM,
    --FDW_LEG_MISC_CHRG_CD,
    --SHPT_CUST_ID_ISO_CTRY_CD,
    --LEG_ORD_CR_FG,
    --LEG_SHIP_VIA_CD
    SO_OPT_QT,
    RSTD_BILT_CUST_ID,
    RSTD_SHPT_CUST_ID,
    RSTD_SLDT_CUST_ID,
    RSTD_END_CUST_ID ,
    FIN_RPTBL_FG ,
    NET_DEALER_PRC_USD_AM,
    PIPELN_CD,
    STD_CST_EXT_SO_USD_AM,
    PRIM_AGNT_ID,
    DLVR_MTHD_CD,
    WBS_ID,
    SRVC_GDS_PROD_ID,
    PKG_PROD_ID,
    SUPLYG_DIV_SUB_ENT_CD,
    UNRSTD_BUS_AREA_CD,
    RSTD_CUST_UPD_IND,
    RSTD_CUST_UPD_GMT_TS,
    REC_EXPLN_PRCS_CD,
    DRVD_END_CUST_PATH_CD,
    -------------three new columns
    RTE_CD,
    MKT_SEG_CD,
    MKT_OFR_CD,
    CNTRCT_STRT_DT,
    CNTRCT_END_DT,
    SO_PREPAYM_TYPE_CD,
    TOT_NET_EXT_SO_AM,
    TOT_NET_EXT_SO_USD_AM,
    PRIM_SO_ADJ_CD
) SELECT
    SO_DTL_RPT_F.SPRN_CO_ID,
    SO_DTL_RPT_F.SLS_OFF_CD,
    SO_DTL_RPT_F.CUST_CNTRCT_ID,
    SO_DTL_RPT_F.DSTRB_CHNL_CD,
    SO_DTL_RPT_F.SLS_FRC_CD,
    NVL(SO_DTL_RPT_F.QTA_PROD_LN_ID,' '),
    --TRANSLATE(SO_TYPE_D.SO_TYPE_CLS_NM USING ISO88591ToUCS2) ,
    NVL(SO_DTL_RPT_F.NET_EXT_SO_LC_AM,0),
    NVL(SO_DTL_RPT_F.SO_DTL_QT,0),
    SO_DTL_RPT_F.SO_DTL_EXT_QT,
    NVL(SO_DTL_RPT_F.GRS_EXT_SO_LC_AM,0),
    --EXTRC_MAPPING.EXTRC_FDW_CD,
    NVL(SO_DTL_RPT_F.NET_EXT_SO_USD_AM,0),
    NVL(SO_DTL_RPT_F.GRS_EXT_SO_USD_AM,0),
    SO_DTL_RPT_F.ORD_RSN_CD,
    SO_DTL_RPT_F.CUST_PO_ID,
    SO_DTL_RPT_F.BUS_TYPE_CD,
    --0,
    SO_DTL_RPT_F.PROMO_CD,
    SO_DTL_RPT_F.CUST_REQD_DLVR_DT,
    SO_DTL_RPT_F.SHPT_ISO_CTRY_CD,
    SO_DTL_RPT_F.LOAD_JOB_NR,
    SO_DTL_RPT_F.UPD_GMT_TS,
    SO_DTL_RPT_F.LEG_SO_ID,
    SO_DTL_RPT_F.LEG_SO_LN_ITM_ID,
    SO_DTL_RPT_F.INVN_CLS_CD,
    --NVL(SO_TYPE_D.REV_FG,' '),
    --0,
    --0,
    SO_DTL_RPT_F.SLS_REP_CD,
    SO_DTL_RPT_F.CUST_APP_CD,
    SO_DTL_RPT_F.SLS_ORG_CD,
    --' ', --SO_ADJ_RPT_F.GL_GRP_ACCT_ID
    SO_DTL_RPT_F.BIG_DEAL_ID,
    NVL(SO_DTL_RPT_F.SO_MTHD_CD,' '),
    --SO_TYPE_D.LEG_STAT_BILL_CD,
    SO_DTL_RPT_F.CMRCL_CD,
    SO_DTL_RPT_F.REC_EXPLN_CD,
    SO_DTL_RPT_F.LC_CD,
    SO_DTL_RPT_F.LC_EXCH_RT,
    --NVL(SO_DTL_RPT_F.SRC_PROD_LN_ID,' '),
    SO_DTL_RPT_F.PRFT_CTR_CD,
    --' ', --SO_ADJ_RPT_F.FUNC_AREA_CD
    SO_DTL_RPT_F.SO_ID,
    SO_DTL_RPT_F.SRC_SYS_KY,
    SO_DTL_RPT_F.ORD_CRT_DT,
    SO_DTL_RPT_F.SO_LN_ITM_ID,
    SO_DTL_RPT_F.EFF_FRM_GMT_TS,
    SO_DTL_RPT_F.CONTRA_FG,
    SO_DTL_RPT_F.BUS_AREA_CD,
    SO_DTL_RPT_F.PROD_ID,
    SO_DTL_RPT_F.SLDT_CUST_ID,
    SO_DTL_RPT_F.SHPT_CUST_ID,
    SO_DTL_RPT_F.BILT_CUST_ID,
    SO_DTL_RPT_F.END_CUST_ID,
    SO_DTL_RPT_F.CROSS_BORD_FG,
    SO_DTL_RPT_F.SO_TYPE_CD,
    SO_DTL_RPT_F.OM_SRC_SYS_KY,
    NVL(SO_DTL_RPT_F.SLS_CHNL_CD,' '),
    SO_DTL_RPT_F.FIN_CLOSE_DT,
    SO_DTL_RPT_F.SO_DTL_STAT_CD,
    NVL(SO_DTL_RPT_F.SRC_PROD_LN_ID,' '),
    SO_DTL_RPT_F.DOC_CRNCY_CD,
    NVL(SO_DTL_RPT_F.LEGL_CO_CD,' '),
    --'****', --SO_ADJ_RPT_F.SO_ADJ_CD
    --CURRENT,
    SO_DTL_RPT_F.EFF_TO_GMT_TS,
    NVL(SO_DTL_RPT_F.DRVD_END_CUST_ID ,' ' ),
    --NVL(SO_TYPE_D.QTA_CR_FG,' '),
    --' ', --NVL(ADJ_D.HP_QTA_CNTB_FG,' ')
    --NVL(SO_TYPE_D.MKT_CHNL_CD,' '),
    NVL(SO_DTL_RPT_F.CBN_ID, ' '),
    --'nonIVC',
    --'nonIVC',
    --'nonIVC',
    --'nonIVC',
    --NVL(SO_TYPE_D.LEG_ORD_TYPE_CD,' '),
    --NVL(PROD_D.PROD_OPT_CD,' '),
    --NVL(EXTRC_MAPPING.EXTRC_FDW_CD,' '),
    --NVL(PROD_LN_D.VALU_VOL_NM,' '),
    NVL(SO_DTL_RPT_F.GRS_EXT_SO_AM,0),
    NVL(SO_DTL_RPT_F.NET_EXT_SO_AM,0),
    NVL(SO_DTL_RPT_F.ORIG_PROD_ID, ' '),
    --0,--SO_ADJ_RPT_F.SO_ADJ_AM,
    --' ',--FDW_MISC_CHRG_CD
    --NVL(CUST_D.GEO_CD, ' '),
    --NVL(SO_TYPE_D.LEG_ORD_CR_FG, ' '),
    --NVL(SO_TYPE_D.LEG_SHIP_VIA_CD, ' ')
    NVL(SO_DTL_RPT_F.SO_OPT_QT,0),
    NVL(SO_DTL_RPT_F.RSTD_BILT_CUST_ID,' ' ),
    NVL(SO_DTL_RPT_F.RSTD_SHPT_CUST_ID,' ' ),
    NVL(SO_DTL_RPT_F.RSTD_SLDT_CUST_ID,' ' ),
    NVL(SO_DTL_RPT_F.RSTD_END_CUST_ID ,' ' ),
    SO_DTL_RPT_F.FIN_RPTBL_FG ,
    SO_DTL_RPT_F.NET_DEALER_PRC_USD_AM,
    NVL(SO_DTL_RPT_F.PIPELN_CD ,' ' ),
    0,--NVL(SO_DTL_RPT_F.STD_CST_EXT_SO_USD_AM ,0 ),
    NVL(SO_DTL_RPT_F.PRIM_AGNT_ID ,' ' ),
    NVL(SO_DTL_RPT_F.DLVR_MTHD_CD ,' ' ),
    SO_DTL_RPT_F.WBS_ID,
    NVL(SO_DTL_RPT_F.SRVC_GDS_PROD_ID ,' ' ), --uncommented line to fix bug 13098
    NVL(PKG_PROD_ID, ' '),
    NVL(SO_DTL_RPT_F.SUPLYG_DIV_SUB_ENT_CD,' '),
    SO_DTL_RPT_F.UNRSTD_BUS_AREA_CD,
    CASE WHEN SO_DTL_RPT_F.UPD_GMT_TS < TIMESTAMP '%(EFF_TO_UPD_GMT_TS_FOR_XTR_ORD)s' THEN 'Y' ELSE 'N'
      END AS RSTD_CUST_UPD_IND,
    SO_DTL_RPT_F.RSTD_CUST_UPD_GMT_TS,
    SO_DTL_RPT_F.REC_EXPLN_PRCS_CD,
    SO_DTL_RPT_F.DRVD_END_CUST_PATH_CD,
    SO_DTL_RPT_F.RTE_CD,
    NVL(WBS_D.MKT_SEG_CD,'?') AS MKT_SEG_CD,
    NVL(WBS_D.MKT_OFR_CD,'?') AS MKT_OFR_CD,
    SO_DTL_RPT_F.CNTRCT_STRT_DT AS CNTRCT_STRT_DT,
    SO_DTL_RPT_F.CNTRCT_END_DT AS CNTRCT_END_DT,
    SO_DTL_RPT_F.SO_PREPAYM_TYPE_CD AS SO_PREPAYM_TYPE_CD,
    SO_DTL_RPT_F.TOT_NET_EXT_SO_AM AS TOT_NET_EXT_SO_AM,
    SO_DTL_RPT_F.TOT_NET_EXT_SO_USD_AM AS TOT_NET_EXT_SO_USD_AM,
    SO_DTL_RPT_F.PRIM_SO_ADJ_CD AS PRIM_SO_ADJ_CD
FROM 
    SO_DTL_RPT_F SO_DTL_RPT_F
INNER JOIN STG_ORD_EXTRC_DRV_ETL STG_ORD_EXTRC_DRV_ETL
on
SO_DTL_RPT_F.FIN_CLOSE_DT = STG_ORD_EXTRC_DRV_ETL.FIN_CLOSE_DT AND 
SO_DTL_RPT_F.SRC_SYS_KY = STG_ORD_EXTRC_DRV_ETL.SRC_SYS_KY  AND
SO_DTL_RPT_F.SO_ID  = STG_ORD_EXTRC_DRV_ETL.SO_ID AND
SO_DTL_RPT_F.ORD_CRT_DT = STG_ORD_EXTRC_DRV_ETL.ORD_CRT_DT  AND
SO_DTL_RPT_F.SO_LN_ITM_ID = STG_ORD_EXTRC_DRV_ETL.SO_LN_ITM_ID   AND
SO_DTL_RPT_F.EFF_FRM_GMT_TS =STG_ORD_EXTRC_DRV_ETL.EFF_FRM_GMT_TS
INNER JOIN SRC_SYS_D SSD
ON 
    SSD.SRC_SYS_KY  =  SO_DTL_RPT_F.SRC_SYS_KY
INNER JOIN WBS_D WBS_D
ON  SO_DTL_RPT_F.WBS_ID = WBS_D.WBS_ID
AND SSD.ROLLUP_DFLT_CO_ID  = WBS_D.SPRN_CO_ID
WHERE  SO_DTL_RPT_F.FIN_CLOSE_DT >= DATE '2009-11-01'
--   AND
--    (    SO_DTL_RPT_F.UPD_GMT_TS >= TIMESTAMP '%(EFF_TO_UPD_GMT_TS_FOR_XTR_ORD)s'
--      OR SO_DTL_RPT_F.RSTD_CUST_UPD_GMT_TS >= TIMESTAMP '%(EFF_TO_UPD_GMT_TS_FOR_XTR_ORD)s'
--    )
  
   AND
    (    SO_DTL_RPT_F.SRC_SYS_KY NOT IN (21,2021,6021,5021)  -- For Seattle: Add SSK 5021
      OR SO_DTL_RPT_F.SO_TYPE_CD NOT IN ('ZCR', 'ZDR')
      OR SO_DTL_RPT_F.ORD_RSN_CD NOT IN ('110', '120','130', '140', '260', 'CTR')
    )
   AND
    (    SO_DTL_RPT_F.SRC_SYS_KY NOT IN (1,2001,6001,5001) -- For Seattle: Add SSK 5001
      OR SO_DTL_RPT_F.SO_TYPE_CD NOT IN ('ZBCR','ZBDR')
    )
--   AND NOT
--    (     SO_DTL_RPT_F.RSTD_CUST_UPD_GMT_TS <> SO_DTL_RPT_F.INS_GMT_TS
--      AND SO_DTL_RPT_F.CROSS_BORD_FG IN ( 'O', 'X' , 'Z', 'Y')
--    )

FOR READ UNCOMMITTED ACCESS IN SHARE MODE
--ORDER BY 43,44,45,46,47,48,49,50,53,54,52,51,56,57,59,60,61,64,42,41,32,37,55,65
;

INSERT WITH NO ROLLBACK INTO STG_ORD_EXTRC_DTL_ETL(
        SPRN_CO_ID,
	SLS_OFF_CD,
	CUST_CNTRCT_ID,
	DSTRB_CHNL_CD,
	SLS_FRC_CD,
	QTA_PROD_LN_ID,
	--SO_TYPE_CLS_NM,
	NET_EXT_SO_LC_AM,
	SO_DTL_QT,
	SO_DTL_EXT_QT,
	GRS_EXT_SO_LC_AM,
	--FDW_WORLD_CTRY_CD,
	NET_EXT_SO_USD_AM,
	GRS_EXT_SO_USD_AM,
	ORD_RSN_CD,
	CUST_PO_ID,
	BUS_TYPE_CD,
	--SO_ADJ_QT,
	PROMO_CD,
	CUST_REQD_DLVR_DT,
	SHPT_ISO_CTRY_CD,
	LOAD_JOB_NR,
	UPD_GMT_TS,
	LEG_SO_ID,
	LEG_SO_LN_ITM_ID,
	INVN_CLS_CD,
	--REV_FG,
	--SO_ADJ_USD_AM,
	--SO_ADJ_LC_AM,
	SLS_REP_CD,
	CUST_APP_CD,
	SLS_ORG_CD,
	--GL_GRP_ACCT_ID,
	BIG_DEAL_ID,
	SO_MTHD_CD,
	--LEG_STATSTCL_BILL_CD,
	CMRCL_CD,
	REC_EXPLN_CD,
	LC_CD,
	LC_EXCH_RT,
	--FDW_PROD_HIER_LVL_02_CD,
	PRFT_CTR_CD,
	--FUNC_AREA_CD,
	SO_ID,
	SRC_SYS_KY,
	ORD_CRT_DT,
	SO_LN_ITM_ID,
	EFF_FRM_GMT_TS,
	CONTRA_FG,
	BUS_AREA_CD,
	PROD_ID,
	SLDT_CUST_ID,
	SHPT_CUST_ID,
	BILT_CUST_ID,
	END_CUST_ID,
	CROSS_BORD_FG,
	SO_TYPE_CD,
	OM_SRC_SYS_KY,
	SLS_CHNL_CD,
	FIN_CLOSE_DT,
	SO_DTL_STAT_CD,
	SRC_PROD_LN_ID,
	DOC_CRNCY_CD,
	LEGL_CO_CD,
	--SO_ADJ_CD,
	--EXTRC_EFF_TS,
	EFF_TO_GMT_TS,
	DRVD_END_CUST_ID,
	--QTA_CR_FG,
	--HP_QTA_CNTB_FG,
	--MKT_CHNL_CD,
	CBN_ID,
	--SLDT_CUST_ID_VAL_STAT_CD,
	--SHPT_CUST_ID_VAL_STAT_CD,
	--BILT_CUST_ID_VAL_STAT_CD,
	--END_CUST_ID_VAL_STAT_CD	,
	--LEG_ORD_TYPE_CD,
	--PROD_OPT_CD,
	--SPLIT_WORLD_CTRY_CD,
	--VALU_VOL_NM,
	GRS_EXT_SO_AM,
	NET_EXT_SO_AM,
	ORIG_PROD_ID,
	--SO_ADJ_AM,
	--FDW_LEG_MISC_CHRG_CD,
	--SHPT_CUST_ID_ISO_CTRY_CD,
	--LEG_ORD_CR_FG,
	--LEG_SHIP_VIA_CD
	SO_OPT_QT,
	RSTD_BILT_CUST_ID,
	RSTD_SHPT_CUST_ID,
	RSTD_SLDT_CUST_ID,
	RSTD_END_CUST_ID ,
	FIN_RPTBL_FG ,
	NET_DEALER_PRC_USD_AM,
	PIPELN_CD,
	STD_CST_EXT_SO_USD_AM,
	PRIM_AGNT_ID,
	DLVR_MTHD_CD,
	WBS_ID,
	SRVC_GDS_PROD_ID,
	PKG_PROD_ID,
	SUPLYG_DIV_SUB_ENT_CD,
	UNRSTD_BUS_AREA_CD,
	RSTD_CUST_UPD_IND,
	RSTD_CUST_UPD_GMT_TS,
	REC_EXPLN_PRCS_CD,
	DRVD_END_CUST_PATH_CD,
	RTE_CD,
	MKT_SEG_CD,
	MKT_OFR_CD,
	CNTRCT_STRT_DT,
	CNTRCT_END_DT,
	SO_PREPAYM_TYPE_CD,
	TOT_NET_EXT_SO_AM,
	TOT_NET_EXT_SO_USD_AM,
	PRIM_SO_ADJ_CD
) SELECT
	SO_DTL_RPT_F.SPRN_CO_ID,
	SO_DTL_RPT_F.SLS_OFF_CD,
	SO_DTL_RPT_F.CUST_CNTRCT_ID,
	SO_DTL_RPT_F.DSTRB_CHNL_CD,
	SO_DTL_RPT_F.SLS_FRC_CD,
	NVL(SO_DTL_RPT_F.QTA_PROD_LN_ID,' '),
--	TRANSLATE(SO_TYPE_D.SO_TYPE_CLS_NM USING ISO88591ToUCS2) ,
	NVL(SO_DTL_RPT_F.NET_EXT_SO_LC_AM,0),
	NVL(SO_DTL_RPT_F.SO_DTL_QT,0),
	SO_DTL_RPT_F.SO_DTL_EXT_QT,
	NVL(SO_DTL_RPT_F.GRS_EXT_SO_LC_AM,0),
	--EXTRC_MAPPING.EXTRC_FDW_CD,
	NVL(SO_DTL_RPT_F.NET_EXT_SO_USD_AM,0),
	NVL(SO_DTL_RPT_F.GRS_EXT_SO_USD_AM,0),
	SO_DTL_RPT_F.ORD_RSN_CD,
	SO_DTL_RPT_F.CUST_PO_ID,
	SO_DTL_RPT_F.BUS_TYPE_CD,
	--0,
	SO_DTL_RPT_F.PROMO_CD,
	SO_DTL_RPT_F.CUST_REQD_DLVR_DT,
	SO_DTL_RPT_F.SHPT_ISO_CTRY_CD,
	SO_DTL_RPT_F.LOAD_JOB_NR,
	SO_DTL_RPT_F.UPD_GMT_TS,
	SO_DTL_RPT_F.LEG_SO_ID,
	SO_DTL_RPT_F.LEG_SO_LN_ITM_ID,
	SO_DTL_RPT_F.INVN_CLS_CD,
	--NVL(SO_TYPE_D.REV_FG,' '),
	--0,
	--0,
	SO_DTL_RPT_F.SLS_REP_CD,
	SO_DTL_RPT_F.CUST_APP_CD,
	SO_DTL_RPT_F.SLS_ORG_CD,
	--' ', --SO_ADJ_RPT_F.GL_GRP_ACCT_ID
	SO_DTL_RPT_F.BIG_DEAL_ID,
	NVL(SO_DTL_RPT_F.SO_MTHD_CD,' '),
	--SO_TYPE_D.LEG_STAT_BILL_CD,
	SO_DTL_RPT_F.CMRCL_CD,
	SO_DTL_RPT_F.REC_EXPLN_CD,
	SO_DTL_RPT_F.LC_CD,
	SO_DTL_RPT_F.LC_EXCH_RT,
	--NVL(SO_DTL_RPT_F.SRC_PROD_LN_ID,' '),
	SO_DTL_RPT_F.PRFT_CTR_CD,
	--' ', --SO_ADJ_RPT_F.FUNC_AREA_CD
	SO_DTL_RPT_F.SO_ID,
	SO_DTL_RPT_F.SRC_SYS_KY,
	SO_DTL_RPT_F.ORD_CRT_DT,
	SO_DTL_RPT_F.SO_LN_ITM_ID,
	SO_DTL_RPT_F.EFF_FRM_GMT_TS,
	SO_DTL_RPT_F.CONTRA_FG,
	SO_DTL_RPT_F.BUS_AREA_CD,
	SO_DTL_RPT_F.PROD_ID,
	SO_DTL_RPT_F.SLDT_CUST_ID,
	SO_DTL_RPT_F.SHPT_CUST_ID,
	SO_DTL_RPT_F.BILT_CUST_ID,
	SO_DTL_RPT_F.END_CUST_ID,
	SO_DTL_RPT_F.CROSS_BORD_FG,
	SO_DTL_RPT_F.SO_TYPE_CD,
	SO_DTL_RPT_F.OM_SRC_SYS_KY,
	NVL(SO_DTL_RPT_F.SLS_CHNL_CD,' '),
	SO_DTL_RPT_F.FIN_CLOSE_DT,
	SO_DTL_RPT_F.SO_DTL_STAT_CD,
	NVL(SO_DTL_RPT_F.SRC_PROD_LN_ID,' '),
	SO_DTL_RPT_F.DOC_CRNCY_CD,
	NVL(SO_DTL_RPT_F.LEGL_CO_CD,' '),
	--'****', --SO_ADJ_RPT_F.SO_ADJ_CD
	--CURRENT,
	SO_DTL_RPT_F.EFF_TO_GMT_TS,
	NVL(SO_DTL_RPT_F.DRVD_END_CUST_ID ,' ' ),
	--NVL(SO_TYPE_D.QTA_CR_FG,' '),
	--' ', --NVL(ADJ_D.HP_QTA_CNTB_FG,' ')
	--NVL(SO_TYPE_D.MKT_CHNL_CD,' '),
	NVL(SO_DTL_RPT_F.CBN_ID, ' '),
	--'nonIVC',
	--'nonIVC',
	--'nonIVC',
	--'nonIVC',
	--NVL(SO_TYPE_D.LEG_ORD_TYPE_CD,' '),
	--NVL(PROD_D.PROD_OPT_CD,' '),
	--NVL(EXTRC_MAPPING.EXTRC_FDW_CD,' '),
	--NVL(PROD_LN_D.VALU_VOL_NM,' '),
	NVL(SO_DTL_RPT_F.GRS_EXT_SO_AM,0),
	NVL(SO_DTL_RPT_F.NET_EXT_SO_AM,0),
	NVL(SO_DTL_RPT_F.ORIG_PROD_ID, ' '),
	--0,--SO_ADJ_RPT_F.SO_ADJ_AM,
	--' ',--FDW_MISC_CHRG_CD
	--NVL(CUST_D.GEO_CD, ' '),
	--NVL(SO_TYPE_D.LEG_ORD_CR_FG, ' '),
	--NVL(SO_TYPE_D.LEG_SHIP_VIA_CD, ' ')
	NVL(SO_DTL_RPT_F.SO_OPT_QT,0),
	NVL(SO_DTL_RPT_F.RSTD_BILT_CUST_ID,' ' ),
	NVL(SO_DTL_RPT_F.RSTD_SHPT_CUST_ID,' ' ),
	NVL(SO_DTL_RPT_F.RSTD_SLDT_CUST_ID,' ' ),
	NVL(SO_DTL_RPT_F.RSTD_END_CUST_ID ,' ' ),
	SO_DTL_RPT_F.FIN_RPTBL_FG ,
	SO_DTL_RPT_F.NET_DEALER_PRC_USD_AM,
	NVL(SO_DTL_RPT_F.PIPELN_CD ,' ' ),
	0,--NVL(SO_DTL_RPT_F.STD_CST_EXT_SO_USD_AM ,0 ),
	NVL(SO_DTL_RPT_F.PRIM_AGNT_ID ,' ' ),
	NVL(SO_DTL_RPT_F.DLVR_MTHD_CD ,' ' ),
	SO_DTL_RPT_F.WBS_ID,
	NVL(SO_DTL_RPT_F.SRVC_GDS_PROD_ID ,' ' ), --uncommented line to fix bug 13098
	NVL(PKG_PROD_ID, ' '),
	NVL(SO_DTL_RPT_F.SUPLYG_DIV_SUB_ENT_CD,' '),
	SO_DTL_RPT_F.UNRSTD_BUS_AREA_CD,
	CASE WHEN SO_DTL_RPT_F.UPD_GMT_TS < TIMESTAMP '%(EFF_TO_UPD_GMT_TS_FOR_XTR_ORD)s' THEN 'Y' ELSE 'N'
	  END AS RSTD_CUST_UPD_IND,
	SO_DTL_RPT_F.RSTD_CUST_UPD_GMT_TS,
	SO_DTL_RPT_F.REC_EXPLN_PRCS_CD,
	SO_DTL_RPT_F.DRVD_END_CUST_PATH_CD,
	SO_DTL_RPT_F.RTE_CD,
	NVL(WBS_D.MKT_SEG_CD,'?') AS MKT_SEG_CD,
	NVL(WBS_D.MKT_OFR_CD,'?') AS MKT_OFR_CD,
	SO_DTL_RPT_F.CNTRCT_STRT_DT AS CNTRCT_STRT_DT,
	SO_DTL_RPT_F.CNTRCT_END_DT AS CNTRCT_END_DT,
	SO_DTL_RPT_F.SO_PREPAYM_TYPE_CD AS SO_PREPAYM_TYPE_CD,
	SO_DTL_RPT_F.TOT_NET_EXT_SO_AM AS TOT_NET_EXT_SO_AM,
	SO_DTL_RPT_F.TOT_NET_EXT_SO_USD_AM AS TOT_NET_EXT_SO_USD_AM,
	SO_DTL_RPT_F.PRIM_SO_ADJ_CD AS PRIM_SO_ADJ_CD
FROM SO_DTL_RPT_F SO_DTL_RPT_F
INNER JOIN STG_ORD_EXTRC_DRV_ETL STG_ORD_EXTRC_DRV_ETL
on
SO_DTL_RPT_F.FIN_CLOSE_DT = STG_ORD_EXTRC_DRV_ETL.FIN_CLOSE_DT AND  
SO_DTL_RPT_F.SRC_SYS_KY = STG_ORD_EXTRC_DRV_ETL.SRC_SYS_KY  AND
SO_DTL_RPT_F.SO_ID  = STG_ORD_EXTRC_DRV_ETL.SO_ID AND
SO_DTL_RPT_F.ORD_CRT_DT = STG_ORD_EXTRC_DRV_ETL.ORD_CRT_DT  AND
SO_DTL_RPT_F.SO_LN_ITM_ID = STG_ORD_EXTRC_DRV_ETL.SO_LN_ITM_ID   AND
SO_DTL_RPT_F.EFF_FRM_GMT_TS = STG_ORD_EXTRC_DRV_ETL.EFF_FRM_GMT_TS
INNER JOIN SRC_SYS_D SSD
ON 
    SSD.SRC_SYS_KY  =  SO_DTL_RPT_F.SRC_SYS_KY
INNER JOIN WBS_D WBS_D
ON SO_DTL_RPT_F.WBS_ID = WBS_D.WBS_ID
AND SSD.ROLLUP_DFLT_CO_ID  = WBS_D.SPRN_CO_ID
WHERE SO_DTL_RPT_F.FIN_CLOSE_DT <= DATE '2009-10-31'
--   AND
--    (    SO_DTL_RPT_F.UPD_GMT_TS >= TIMESTAMP '%(EFF_TO_UPD_GMT_TS_FOR_XTR_ORD)s'
--      OR SO_DTL_RPT_F.RSTD_CUST_UPD_GMT_TS >= TIMESTAMP '%(EFF_TO_UPD_GMT_TS_FOR_XTR_ORD)s'
--    )
   AND
    (    SO_DTL_RPT_F.SRC_SYS_KY NOT IN (21,2021,6021,5021) --Add SSK for Seattle change
      OR SO_DTL_RPT_F.SO_TYPE_CD NOT IN ('ZCR', 'ZDR')
      OR SO_DTL_RPT_F.ORD_RSN_CD NOT IN ('110', '120','130', '140', '260', 'CTR')
    )
   AND
    (    SO_DTL_RPT_F.SRC_SYS_KY NOT IN (1,2001,6001,5001) --Add SSK for Seattle change
      OR SO_DTL_RPT_F.SO_TYPE_CD NOT IN ('ZBCR','ZBDR')
    )
--   AND NOT
--    (     SO_DTL_RPT_F.RSTD_CUST_UPD_GMT_TS <> SO_DTL_RPT_F.INS_GMT_TS
--      AND SO_DTL_RPT_F.CROSS_BORD_FG IN ( 'O', 'X', 'Z', 'Y')
--    )

FOR READ UNCOMMITTED ACCESS IN SHARE MODE
--ORDER BY 43,44,45,46,47,48,49,50,53,54,52,51,56,57,59,60,61,64,42,41,32,37,55,65
;


MAINTAIN TABLE STG_ORD_EXTRC_DTL_ETL, UPDATE STATISTICS  'ON NECESSARY COLUMNS';
